<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Library Pro - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --danger: #ef4444; --success: #22c55e; --text: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        /* Navigation */
        nav { background: #1e293b; padding: 1rem 2rem; display: flex; gap: 20px; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
        nav h2 { margin: 0; margin-right: auto; color: var(--accent); font-size: 1.2rem; }
        nav button { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        nav button:hover { background: var(--accent); color: white; }
        nav button i { margin-right: 8px; }

        /* Layout */
        .container { padding: 2rem; max-width: 1200px; margin: auto; }
        .view-section { display: none; }
        .active { display: block !important; }
        
        .grid-layout { display: grid; grid-template-columns: 350px 1fr; gap: 30px; margin-top: 10px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: sticky; top: 180px; }
        
        /* Forms & Inputs */
        .search-header { width: 100%; margin-bottom: 10px; position: relative; }
        .search-header i { position: absolute; left: 15px; top: 18px; color: #64748b; }
        .search-header input { padding-left: 40px; }

        input, select { width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        .btn-main { background: var(--accent); color: #0f172a; border: none; padding: 12px; width: 100%; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-cancel { background: #64748b; color: white; border: none; padding: 8px; width: 100%; border-radius: 6px; cursor: pointer; margin-top: 5px; display: none; }

        /* Notification Area */
        .msg-area { height: 40px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 600; transition: opacity 0.3s ease; opacity: 0; }
        .msg-success { background: rgba(34, 197, 94, 0.2); color: var(--success); border: 1px solid var(--success); opacity: 1; }
        .msg-error { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); opacity: 1; }
        .msg-area i { margin-right: 10px; }

        /* List Styling */
        .list-item { background: #334155; padding: 15px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--accent); }
        .actions { display: flex; gap: 8px; }
        .btn-edit { background: var(--success); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .btn-del { background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .btn-edit:hover, .btn-del:hover { opacity: 0.8; }
        
        /* Main Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stat-box { text-align: center; padding: 40px; background: var(--card); border-radius: 15px; border: 1px solid #334155; position: relative; overflow: hidden; }
        .stat-box i { position: absolute; font-size: 5rem; color: rgba(56, 189, 248, 0.05); right: -10px; bottom: -10px; }
        .stat-box h1 { font-size: 3rem; margin: 10px 0; color: var(--accent); }
    </style>
</head>
<body>

    <nav>
        <h2><i class="fa-solid fa-book-bookmark"></i> Library Manager</h2>
        <button onclick="showView('main')"><i class="fa-solid fa-house"></i> Home</button>
        <button onclick="showView('authors')"><i class="fa-solid fa-user-pen"></i> Authors</button>
        <button onclick="showView('books')"><i class="fa-solid fa-book"></i> Books</button>
    </nav>

    <div class="container">
        
        <div id="view-main" class="view-section active">
            <h1>System Overview</h1>
            <div class="stats-grid">
                <div class="stat-box">
                    <i class="fa-solid fa-users"></i>
                    <h3>Total Authors</h3>
                    <h1 id="stat-authors">0</h1>
                </div>
                <div class="stat-box">
                    <i class="fa-solid fa-layer-group"></i>
                    <h3>Total Books</h3>
                    <h1 id="stat-books">0</h1>
                </div>
            </div>
        </div>

        <div id="view-authors" class="view-section">
            <div class="search-header">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchAuthInput" placeholder="Search authors by name..." onkeyup="searchAuthors()">
            </div>
            <div id="authMsg" class="msg-area"></div>

            <div class="grid-layout">
                <div class="card">
                    <h3 id="authFormTitle"><i class="fa-solid fa-plus"></i> Add New Author</h3>
                    <input type="hidden" id="editAuthId">
                    <input type="text" id="authName" placeholder="Full Name">
                    <input type="text" id="authBio" placeholder="Biography">
                    <input type="text" id="authCity" placeholder="City">
                    <button class="btn-main" id="authSubmitBtn" onclick="handleAuthorSubmit()">
                        <i class="fa-solid fa-check"></i> <span>Create Author</span>
                    </button>
                    <button class="btn-cancel" id="authCancelBtn" onclick="resetAuthorForm()">
                        <i class="fa-solid fa-xmark"></i> Cancel Edit
                    </button>
                </div>
                <div id="authorList"></div>
            </div>
        </div>

        <div id="view-books" class="view-section">
            <div class="search-header">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchBookInput" placeholder="Search books by title..." onkeyup="searchBooks()">
            </div>
            <div id="bookMsg" class="msg-area"></div>

            <div class="grid-layout">
                <div class="card">
                    <h3 id="bookFormTitle"><i class="fa-solid fa-plus"></i> Add New Book</h3>
                    <input type="hidden" id="editBookId">
                    <input type="text" id="bookTitle" placeholder="Book Title">
                    <input type="number" id="bookYear" placeholder="Publication Year">
                    <input type="text" id="bookIsbn" placeholder="ISBN Number">
                    <select id="authDropdown"><option value="">Select Author</option></select>
                    <button class="btn-main" id="bookSubmitBtn" onclick="handleBookSubmit()">
                        <i class="fa-solid fa-check"></i> <span>Add Book</span>
                    </button>
                    <button class="btn-cancel" id="bookCancelBtn" onclick="resetBookForm()">
                        <i class="fa-solid fa-xmark"></i> Cancel Edit
                    </button>
                </div>
                <div id="bookList"></div>
            </div>
        </div>
    </div>

    <script>
        const API = "http://127.0.0.1:5000/api";

        function showStatus(message, type = 'success') {
            const activeView = document.querySelector('.view-section.active').id;
            let msgElement = (activeView === 'view-authors') ? document.getElementById('authMsg') : document.getElementById('bookMsg');
            if(!msgElement) return;

            const icon = type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation';
            msgElement.innerHTML = `<i class="fa-solid ${icon}"></i> ${message}`;
            msgElement.className = `msg-area ${type === 'success' ? 'msg-success' : 'msg-error'}`;
            
            setTimeout(() => {
                msgElement.className = 'msg-area';
                msgElement.innerHTML = '';
            }, 3000);
        }

        function showView(viewName) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            refreshAllData();
        }

        async function refreshAllData() {
            try {
                const authors = (await (await fetch(`${API}/authors`)).json()).authors;
                const books = (await (await fetch(`${API}/books`)).json()).books;
                document.getElementById('stat-authors').innerText = authors.length;
                document.getElementById('stat-books').innerText = books.length;
                renderAuthors(authors);
                renderBooks(books);
                const select = document.getElementById('authDropdown');
                select.innerHTML = authors.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            } catch (e) { console.error(e); }
        }

        function renderAuthors(data) {
            const list = document.getElementById('authorList');
            list.innerHTML = data.map(a => `
                <div class="list-item">
                    <div><strong>${a.name}</strong><br><small><i class="fa-solid fa-location-dot"></i> ${a.city}</small></div>
                    <div class="actions">
                        <button class="btn-edit" onclick="prepareEditAuthor(${a.id})"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button class="btn-del" onclick="deleteItem('authors', ${a.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function renderBooks(data) {
            const list = document.getElementById('bookList');
            list.innerHTML = data.map(b => `
                <div class="list-item">
                    <div><strong>${b.title}</strong><br><small><i class="fa-solid fa-calendar-days"></i> ${b.year}</small></div>
                    <div class="actions">
                        <button class="btn-edit" onclick="prepareEditBook(${b.id})"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button class="btn-del" onclick="deleteItem('books', ${b.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function prepareEditAuthor(id) {
            const res = await fetch(`${API}/authors/${id}`);
            const data = await res.json();
            const a = data.author;
            document.getElementById('editAuthId').value = a.id;
            document.getElementById('authName').value = a.name;
            document.getElementById('authBio').value = a.bio;
            document.getElementById('authCity').value = a.city;
            document.getElementById('authFormTitle').innerHTML = '<i class="fa-solid fa-user-gear"></i> Edit Author Details';
            document.getElementById('authSubmitBtn').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Changes';
            document.getElementById('authCancelBtn').style.display = "block";
            showStatus("Edit mode enabled");
        }

        function resetAuthorForm() {
            document.getElementById('editAuthId').value = "";
            document.getElementById('authName').value = "";
            document.getElementById('authBio').value = "";
            document.getElementById('authCity').value = "";
            document.getElementById('authFormTitle').innerHTML = '<i class="fa-solid fa-plus"></i> Add New Author';
            document.getElementById('authSubmitBtn').innerHTML = '<i class="fa-solid fa-check"></i> Create Author';
            document.getElementById('authCancelBtn').style.display = "none";
        }

        async function handleAuthorSubmit() {
            const id = document.getElementById('editAuthId').value;
            const payload = { name: document.getElementById('authName').value, bio: document.getElementById('authBio').value, city: document.getElementById('authCity').value };
            const method = id ? 'PUT' : 'POST';
            await fetch(id ? `${API}/authors/${id}` : `${API}/authors`, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            showStatus(id ? "Author updated!" : "Author added!");
            resetAuthorForm();
            refreshAllData();
        }

        async function prepareEditBook(id) {
            const res = await fetch(`${API}/books/${id}`);
            const data = await res.json();
            const b = data.book;
            document.getElementById('editBookId').value = b.id;
            document.getElementById('bookTitle').value = b.title;
            document.getElementById('bookYear').value = b.year;
            document.getElementById('bookIsbn').value = b.isbn;
            document.getElementById('authDropdown').value = b.author_id;
            document.getElementById('bookFormTitle').innerHTML = '<i class="fa-solid fa-file-pen"></i> Edit Book Details';
            document.getElementById('bookSubmitBtn').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Changes';
            document.getElementById('bookCancelBtn').style.display = "block";
            showStatus("Edit mode enabled");
        }

        function resetBookForm() {
            document.getElementById('editBookId').value = "";
            document.getElementById('bookTitle').value = "";
            document.getElementById('bookYear').value = "";
            document.getElementById('bookIsbn').value = "";
            document.getElementById('bookFormTitle').innerHTML = '<i class="fa-solid fa-plus"></i> Add New Book';
            document.getElementById('bookSubmitBtn').innerHTML = '<i class="fa-solid fa-check"></i> Add Book';
            document.getElementById('bookCancelBtn').style.display = "none";
        }

        async function handleBookSubmit() {
            const id = document.getElementById('editBookId').value;
            const payload = { title: document.getElementById('bookTitle').value, year: document.getElementById('bookYear').value, isbn: document.getElementById('bookIsbn').value, author_id: document.getElementById('authDropdown').value };
            const method = id ? 'PUT' : 'POST';
            await fetch(id ? `${API}/books/${id}` : `${API}/books`, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            showStatus(id ? "Book updated!" : "Book added!");
            resetBookForm();
            refreshAllData();
        }

        async function deleteItem(type, id) {
            if(confirm("Confirm deletion?")) {
                await fetch(`${API}/${type}/${id}`, { method: 'DELETE' });
                showStatus(`${type === 'authors' ? 'Author' : 'Book'} removed.`);
                refreshAllData();
            }
        }

        async function searchAuthors() {
            const q = document.getElementById('searchAuthInput').value;
            const res = await fetch(`${API}/authors`);
            const data = await res.json();
            renderAuthors(data.authors.filter(a => a.name.toLowerCase().includes(q.toLowerCase())));
        }

        async function searchBooks() {
            const q = document.getElementById('searchBookInput').value;
            const res = await fetch(`${API}/books/search?q=${q}`);
            const data = await res.json();
            renderBooks(data.books);
        }

        refreshAllData();
    </script>
</body>
</html>